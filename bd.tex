\documentclass[11pt,a4paper]{article}
\usepackage[OT4]{fontenc}
\usepackage{polski}
\usepackage[utf8]{inputenc}
\usepackage{fullpage}
\usepackage{tabularx}
\usepackage{enumitem}
\usepackage[polish]{babel}
\usepackage{tikz}
\usepackage{environ}
\usepackage{newfile}
\usepackage{arrayjobx}
\usepackage{rotating}
\usepackage{morefloats}
\usepackage[labelformat=empty]{caption}
\usepackage[titles]{tocloft}
\usetikzlibrary{shapes,arrows,matrix,positioning}

%\addtolength{\textwidth}{1cm}
%\addtolength{\hoffset}{-0.5cm}
\addtolength{\textheight}{1cm}
\addtolength{\voffset}{-0.5cm}

\title{Zintegrowany System Zarządzania\\
Rezerwacjami W Kinie}
\date{Wrocław, 9 kwietnia 2012 r.}
\author{Błażej Święcicki \\
        Antoni Orfin}

\input{defs}

\let\pk\underline
\def\fk#1{\##1}

\linespread{1.3}

\makeatletter
\def\numberline#1{#1 }
\makeatother

\setcounter{tocdepth}{1}

\begin{document}
%\maketitle
\clearpage
\tableofcontents

\begin{etap}{Definicja tematu, celu i założeń przedsięwzięcia}
    \input{etap\arabic{section}}
\end{etap}

\begin{etap}{Szczegółowa analiza rzeczywistości}
    \input{etap\arabic{section}}
\end{etap}

\begin{etap}[KAT]{Definicje kategorii}
    \newenvironment{atrybuty}{\subsubsection*{Atrybuty:}\begin{itemize}}{\end{itemize}}
    \let\kategoria\lsubsection
    \newcommand{\opis}{\subsubsection*{Opis:}}

    \input{etap\arabic{section}}
\end{etap}

\begin{etap}[REG]{Reguły funkcjonowania}
    \begin{descriptionSet}{\sectionID}{regula}
        \input{etap\arabic{section}}
    \end{descriptionSet}
\end{etap}

\begin{etap}[OGR]{Ograniczenia dziedzinowe}
    \newcommand{\kategoria}[1]{\subsection*{\ref{KAT:#1} #1}}
    \newenvironment{ograniczenia}{\begin{descriptionSet}{\sectionID}{ograniczenie}}{\end{descriptionSet}}
    \input{etap\arabic{section}}
\end{etap}

\begin{etap}[TRA]{Transakcje (operacje bazodanowe)}
    \let\transakcja\lsubsection
    \newcommand{\opis}{\subsubsection*{Opis:}}
    \newcommand{\uwarunkowania}{\subsubsection*{Uwarunkowania:}}
    \newenvironment{tabela}{
        \def \AddBeforeEndtabularx {\hline}
        \table[ht]
        \caption{Wejście/Wyjście \thesubsection}
        \tabularx{0.9\textwidth}{|Y|Y|Y|}
        \hline
        & Wejście & Wyjście \\\hline
    }{\endtabularx\endtable}

    \input{etap\arabic{section}}
\end{etap}

\newoutputstream{zwiazki}
\openoutputfile{\jobname.zwi}{zwiazki}
\newoutputstream{encje}
\openoutputfile{\jobname.enc}{encje}

\newarray\Encje
\dataheight=3
\newcounter{encje}
\def\nowaEncja(#1)#2,#3;{
    \stepcounter{encje}
    \Encje(\arabic{encje}, 1)={#1}
    \Encje(\arabic{encje}, 2)={#2}
    \Encje(\arabic{encje}, 3)={#3}
    \expandafter\edef\csname enc@num@#1\endcsname{\arabic{encje}}
}

\newarray\Zwiazki
\newcounter{zwiazki}
\def\nowyZwiazek#1(#2) {
    \stepcounter{zwiazki}
    \Zwiazki(\arabic{zwiazki})={#1(#2)}
}
\def\nazwaZwiazku#1 {
    \def\pole ##1(##2(##3):##4(##5)##6){##1}
    \edef\act{\noexpand\pole#1}
    \act
}
\def\lewaEncjaZwiazku#1 {
    \def\pole ##1(##2(##3):##4(##5)##6){##2}
    \edef\act{\noexpand\pole#1}
    \act
}
\def\prawaEncjaZwiazku#1 {
    \def\pole ##1(##2(##3):##4(##5)##6){##4}
    \edef\act{\noexpand\pole#1}
    \act
}
\begin{etap}[ENC]{Definicje encji i związków}
    \NewEnviron{atrybuty}{\par%
        \def\act##1{\toks0={##1}}
        \expandafter\act\expandafter{\BODY}
        \edef\act{\noexpand\readarray{Atrybuty}{\the\toks0}}
        \act
        \dataheight=4

        \table[ht]
        \begin{tabularx}{\textwidth}{|Y|Y|Y|c|}
        \hline
        Nazwa atrybutu & Opis atrybutu & Typ & OBL/OPC \\
        \hline
        % Wrzucanie elementów do tabeli
        \setcounter{enumii}{1}
        \checkAtrybuty(\arabic{enumii}, 1)%
        \toks1={}%
        \whiledo{\not\equal{\cachedata}{}} {%
            \ifthenelse{\value{enumii} > 1}{\Append{\\}{\toks1}}{}
            \expandafter\Append\expandafter{\Atrybuty(\arabic{enumii}, 1)&}{\toks1}%
            \expandafter\Append\expandafter{\Atrybuty(\arabic{enumii}, 2)&}{\toks1}%
            \expandafter\Append\expandafter{\Atrybuty(\arabic{enumii}, 3)&}{\toks1}%
            \expandafter\Append\expandafter{\Atrybuty(\arabic{enumii}, 4)}{\toks1}%
            \the\toks1%
            \addtocounter{enumii}{1}%
            \checkAtrybuty(\arabic{enumii}, 1)%
        }%
        \\\hline
        \end{tabularx}\endtable
    }
    \newenvironment{encja}[1]{
        \lsubsection{#1}
        \expandafter\def\csname enc@Nazwa\endcsname{#1}
        \newarray\Atrybuty
    }{
        \setcounter{enumii}{1}
        \checkAtrybuty(\arabic{enumii}, 1)%
        \addtostream{encje}{\noexpand \nowaEncja (\csname enc@Nazwa\endcsname) \csname enc@kluczGlowny\endcsname}
        \whiledo{\not\equal{\cachedata}{}} {%
            %\ifthenelse{\equal{\cachedata}{\csname enc@kluczGlowny}}{
            %    \addtostream{encje}{, \textbf{\cachedata}}
            %} {
                \addtostream{encje}{, \cachedata}%
            %}
            \addtocounter{enumii}{1}%
            \checkAtrybuty(\arabic{enumii}, 1)%
        }
        \addtostream{encje}{;}
    }
    \newcommand{\semantyka}{\subsubsection*{Semantyka encji:}}
    \newcommand{\klucze}{\subsubsection*{Klucze kandydujące:}}
    \newcommand{\kluczGlowny}[1]{
        \subsubsection*{Klucz główny:}#1
        \expandafter\def\csname enc@kluczGlowny\endcsname{#1}
    }
    \newcommand{\charakter}[1]{
        \subsubsection*{Charakter encji:} Encja #1%
        \expandafter\def\csname enc@typ\endcsname{#1}%
    }

    \newenvironment{zwiazki}{
        \subsection*{Związki}
        \def\trim##1{\ignorespaces##1\unskip}
        \def\zwiazek ##1(##2(##3),##4(##5)##6) {
            \addtostream{zwiazki} {\noexpand \zwiazek{##1}{##2(##3) : ##4(##5)##6}}
            \addtostream{encje}{\noexpand\nowyZwiazek##1(##2(##3):##4(##5)##6)}
            \begin{tikzpicture}
                \begin{scope}[every node/.style={draw,node distance=5cm, minimum height=3em, minimum width=10em}]
                    \node[rectangle] (##2){##2};
                    \node[asymmetricdiamond] at (0.5\textwidth-5em,0) (##1){##1};
                    \node[rectangle] at (\textwidth-10em-1mm,0) (##4){##4};
                \end{scope}
                \path[-, draw] (##2) -- node[near start, above] {##3} (##1) -- node[near end, above] {##5} (##4);
            \end{tikzpicture}\newline\newline
        }
    }{\relax}

    \input{etap\arabic{section}}
\end{etap}
\closeoutputstream{zwiazki}
\closeoutputstream{encje}
\input{\jobname.enc}

\begin{etap}{Definicje predykatowe encji i związków}
    \let\pk\underline
    \newenvironment{encje}{\subsection*{Encje}\begin{descriptionSet}{ENC}{encja}}{\end{descriptionSet}}
    \newenvironment{zwiazki}{
        \subsection*{Związki}
        \begin{descriptionSet}{ZWI}{zwiazek}
        \renewcommand{\zwiazek}[2]{\padzeroes[3]\stepcounter{enumi}\item[ZWI/\decimal{enumi}]\label{ZWI:##1}\textbf{##1}(##2)}
    }{\end{descriptionSet}}
    \input{etap\arabic{section}}
\end{etap}

\begin{etap}{Diagram obiektowo-związkowy (ERD)}
    \input{etap\arabic{section}}
\end{etap}

\begin{etap}[ZWI]{Transformacja modelu konceptualnego do modelu logicznego}
    \stepcounter{subsection}
    \newcommand{\zwiazek}{
        \checkZwiazki(\arabic{subsection})
        \subsection{\cachedata}
    }
    \newcommand{\encje}{\subsubsection*{Encje}}
    \setlength{\parindent}{0pt}
    \newcommand{\encja}[1][]{\par
        \textbf{\ref{ENC:#1} #1}\relax
    }
    \newcommand{\relacje}{\subsubsection*{Relacje}}
    \newcommand{\relacja}[1]{\par
        \textbf{#1}\relax
    }
    \input{etap\arabic{section}}
\end{etap}

\begin{etap}[REL]{Definicje schematów relacji i przykładowe dane}
    \newenvironment{relacja}[2]{
        \ifthenelse{\value{subsection} = 0}{}{\clearpage}
        \NewEnviron{schemat} {
            \lsubsection{#1/#2}
            \table[ht]
            \caption{Opis schematu relacji \textbf{#1}}
            \begin{tabularx}{\textwidth}{|c|Y|c|c|c|Y|c|c|c|c|}
            \hline
            \begin{sideways}Nazwa Atrybutu\end{sideways} &
            \begin{sideways}Dziedzina\end{sideways}& 
            \begin{sideways}Maska\end{sideways} & 
            \begin{sideways}OBL(+)/OPC(-)\end{sideways}  & 
            \begin{sideways}Wartość domyślna\end{sideways} & 
            \begin{sideways}Ograniczenia\end{sideways} & 
            \begin{sideways}Unikalność\end{sideways} & 
            \begin{sideways}Klucz\end{sideways} & 
            \begin{sideways}Referencje\end{sideways} & 
            \begin{sideways}Źródło danych\end{sideways} \\
            \hline
            \BODY
            \hline
            \end{tabularx}
            \endtable
        }
        
        \NewEnviron{atrybuty}{
            \table[ht]
            \caption{Znaczenie atrybutów relacji \textbf{#1}}
                \begin{tabularx}{\textwidth}{|Y|Y|}
                \hline
                Nazwa atrybutu & znaczenie \\
                \hline
                \BODY
                \hline
                \end{tabularx}
            \endtable
        }
        
        \NewEnviron{przyklady} {
            \table[h!t!]
            \caption{Przykładowe dane tabeli o schemacie relacji \textbf{#1}}
            \BODY
            \endtable
        }
    }{}
    \input{etap\arabic{section}}
\end{etap}

\begin{etap}{Schemat bazy danych ze słownikiem atrybutów}
    \newenvironment{relacje}{
        \newcommand{\relacja}[1]{\item[##1]}
        \begin{description}[leftmargin=10em, style=nextline]
    }{\end{description}}
    \NewEnviron{atrybuty}{
        \table[ht]
        \caption{Słownik atrybutów}
        \begin{tabularx}{\textwidth}{|Y|Y|Y|}
            \hline
            \textbf{Nazwa atrybutu} & \textbf{Dziedzina} & \textbf{Przynależność do schematu relacji}\\
            \hline
            \BODY
            \end{tabularx}
        \endtable
    }
    \input{etap\arabic{section}}
\end{etap}

\begin{etap}[PER]{Użytkownicy i perspektywy}
    \input{etap\arabic{section}}
\end{etap}

\end{document}
